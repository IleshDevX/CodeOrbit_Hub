<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime & Manga Universe</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Custom Styles and Animations -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
            color: #e5e7eb;
        }

        /* Gradient Spotlight Effect */
        .spotlight-effect {
            position: relative;
            overflow: hidden;
        }
        .spotlight-effect::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: radial-gradient(circle at var(--x) var(--y), rgba(45, 212, 191, 0.1), transparent 30%);
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
        }
        .spotlight-effect:hover::before {
            opacity: 1;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #111827;
        }
        ::-webkit-scrollbar-thumb {
            background: #14b8a6;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #0d9488;
        }

        /* Animation Classes for Intersection Observer */
        .fade-in {
            opacity: 0;
            transition: opacity 1s ease-out;
        }
        .fade-in.is-visible {
            opacity: 1;
        }
        .slide-in-up {
            opacity: 0;
            transform: translateY(40px);
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
        }
        .slide-in-up.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Blur backdrop for modal */
        #modal-backdrop.active {
            backdrop-filter: blur(8px);
        }

        /* Custom focus ring */
        .custom-focus-ring:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.4);
        }

        /* Navbar scrolled state */
        .navbar-scrolled {
            background-color: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        /* Range slider styling */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: linear-gradient(45deg, #14b8a6, #3b82f6);
            cursor: pointer;
            border: 2px solid #1f2937;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        input[type="range"]::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: linear-gradient(45deg, #14b8a6, #3b82f6);
            cursor: pointer;
            border: 2px solid #1f2937;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="bg-black text-gray-200 antialiased">

    <!-- Navbar -->
    <nav id="navbar" class="fixed top-0 left-0 right-0 z-40 transition-all duration-300 p-4">
        <div class="container mx-auto flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-white">Anime<span class="text-teal-400">Verse</span></a>
            <div class="hidden md:flex items-center space-x-8">
                <a href="#hero" class="text-gray-300 hover:text-teal-400 transition-colors">Home</a>
                <a href="#top-anime" class="text-gray-300 hover:text-teal-400 transition-colors">Top Anime</a>
                <a href="#about" class="text-gray-300 hover:text-teal-400 transition-colors">About</a>
            </div>
        </div>
    </nav>

    <!-- Header & Hero Section -->
    <header id="hero" class="relative min-h-screen flex items-center justify-center overflow-hidden pt-16">
        <!-- Animated Background -->
        <div class="absolute inset-0 z-0">
            <div class="absolute inset-0 bg-gradient-to-br from-purple-900/20 via-blue-900/20 to-teal-900/20"></div>
            <div class="absolute inset-0 bg-[radial-gradient(circle_at_20%_80%,rgba(120,119,198,0.3),transparent_50%),radial-gradient(circle_at_80%_20%,rgba(45,212,191,0.3),transparent_50%),radial-gradient(circle_at_40%_40%,rgba(139,92,246,0.2),transparent_50%)]"></div>
            <div class="absolute inset-0 bg-gradient-to-t from-black via-black/70 to-black/30"></div>
            <!-- Floating particles -->
            <div class="absolute inset-0 overflow-hidden">
                <div class="absolute w-2 h-2 bg-teal-400/30 rounded-full animate-pulse" style="top: 20%; left: 10%; animation-delay: 0s;"></div>
                <div class="absolute w-1 h-1 bg-purple-400/40 rounded-full animate-pulse" style="top: 60%; left: 80%; animation-delay: 1s;"></div>
                <div class="absolute w-3 h-3 bg-blue-400/20 rounded-full animate-pulse" style="top: 40%; left: 70%; animation-delay: 2s;"></div>
                <div class="absolute w-1 h-1 bg-teal-300/50 rounded-full animate-pulse" style="top: 80%; left: 20%; animation-delay: 3s;"></div>
            </div>
        </div>
        
        <!-- Hero Content -->
        <div class="relative z-10 text-center p-4 max-w-6xl mx-auto">
            <!-- Main Title -->
            <div class="mb-8">
                <h1 class="text-6xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-r from-teal-400 via-blue-400 to-purple-400 mb-4 leading-tight">
                    Anime<span class="text-white">Verse</span>
                </h1>
                <div class="h-1 w-32 bg-gradient-to-r from-teal-400 to-purple-400 mx-auto rounded-full mb-6"></div>
                <p class="text-xl md:text-2xl text-gray-300 max-w-4xl mx-auto leading-relaxed">
                    Discover, explore, and immerse yourself in the <span class="text-teal-400 font-semibold">infinite universe</span> of Japanese animation and manga
                </p>
            </div>

            <!-- Enhanced Search Section -->
            <div class="bg-gray-900/40 backdrop-blur-sm rounded-3xl p-8 mb-8 border border-gray-700/50 shadow-2xl">
                <h2 class="text-2xl font-bold text-white mb-6">Search Your Next Adventure</h2>
                
                <!-- Main Search Form -->
                <form id="search-form" class="space-y-6">
                    <!-- Search Input -->
                    <div class="relative max-w-2xl mx-auto">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <input type="search" id="search-input" 
                               placeholder="Search anime, manga, characters..." 
                               class="w-full pl-12 pr-16 py-4 text-white bg-gray-800/60 backdrop-blur-sm rounded-2xl border-2 border-gray-600/50 focus:border-teal-400 focus:bg-gray-800/80 custom-focus-ring transition-all duration-300 text-lg" 
                               required>
                        <button type="submit" class="absolute top-1/2 right-2 -translate-y-1/2 p-3 bg-gradient-to-r from-teal-500 to-blue-500 hover:from-teal-600 hover:to-blue-600 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Search Type Filters -->
                    <div class="flex flex-wrap justify-center gap-3">
                        <label class="relative cursor-pointer group">
                            <input type="radio" name="searchType" value="anime" class="sr-only" checked>
                            <div class="px-6 py-3 rounded-xl bg-gray-800/60 border-2 border-gray-600/50 group-hover:border-teal-400/50 transition-all duration-300 group-has-[:checked]:bg-gradient-to-r group-has-[:checked]:from-teal-500 group-has-[:checked]:to-blue-500 group-has-[:checked]:border-transparent group-has-[:checked]:text-white">
                                <span class="font-semibold">üì∫ Anime</span>
                            </div>
                        </label>
                        <label class="relative cursor-pointer group">
                            <input type="radio" name="searchType" value="manga" class="sr-only">
                            <div class="px-6 py-3 rounded-xl bg-gray-800/60 border-2 border-gray-600/50 group-hover:border-teal-400/50 transition-all duration-300 group-has-[:checked]:bg-gradient-to-r group-has-[:checked]:from-teal-500 group-has-[:checked]:to-blue-500 group-has-[:checked]:border-transparent group-has-[:checked]:text-white">
                                <span class="font-semibold">üìö Manga</span>
                            </div>
                        </label>
                        <label class="relative cursor-pointer group">
                            <input type="radio" name="searchType" value="character" class="sr-only">
                            <div class="px-6 py-3 rounded-xl bg-gray-800/60 border-2 border-gray-600/50 group-hover:border-teal-400/50 transition-all duration-300 group-has-[:checked]:bg-gradient-to-r group-has-[:checked]:from-teal-500 group-has-[:checked]:to-blue-500 group-has-[:checked]:border-transparent group-has-[:checked]:text-white">
                                <span class="font-semibold">üë§ Characters</span>
                            </div>
                        </label>
                    </div>

                    <!-- Advanced Filters Toggle -->
                    <div class="text-center">
                        <button type="button" id="advanced-filters-toggle" class="text-teal-400 hover:text-teal-300 font-semibold transition-colors duration-300 flex items-center gap-2 mx-auto">
                            <span>Advanced Filters</span>
                            <svg class="w-4 h-4 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Advanced Filters Panel -->
                    <div id="advanced-filters" class="hidden space-y-4 pt-4 border-t border-gray-700/50">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Genre Filter -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-300 mb-2">Genre</label>
                                <select id="genre-filter" class="w-full p-3 bg-gray-800/60 border border-gray-600/50 rounded-xl text-white focus:border-teal-400 custom-focus-ring transition-all duration-300">
                                    <option value="">Any Genre</option>
                                    <option value="1">Action</option>
                                    <option value="2">Adventure</option>
                                    <option value="4">Comedy</option>
                                    <option value="8">Drama</option>
                                    <option value="10">Fantasy</option>
                                    <option value="14">Horror</option>
                                    <option value="22">Romance</option>
                                    <option value="24">Sci-Fi</option>
                                    <option value="27">Shounen</option>
                                    <option value="25">Shoujo</option>
                                </select>
                            </div>
                            
                            <!-- Year Filter -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-300 mb-2">Year</label>
                                <select id="year-filter" class="w-full p-3 bg-gray-800/60 border border-gray-600/50 rounded-xl text-white focus:border-teal-400 custom-focus-ring transition-all duration-300">
                                    <option value="">Any Year</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                    <option value="2022">2022</option>
                                    <option value="2021">2021</option>
                                    <option value="2020">2020</option>
                                    <option value="2019">2019</option>
                                    <option value="2018">2018</option>
                                </select>
                            </div>
                            
                            <!-- Status Filter -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-300 mb-2">Status</label>
                                <select id="status-filter" class="w-full p-3 bg-gray-800/60 border border-gray-600/50 rounded-xl text-white focus:border-teal-400 custom-focus-ring transition-all duration-300">
                                    <option value="">Any Status</option>
                                    <option value="airing">Currently Airing</option>
                                    <option value="complete">Completed</option>
                                    <option value="upcoming">Upcoming</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Rating Filter -->
                        <div class="max-w-md mx-auto">
                            <label class="block text-sm font-semibold text-gray-300 mb-2">Minimum Rating</label>
                            <div class="flex items-center gap-4">
                                <input type="range" id="rating-filter" min="1" max="10" step="0.5" value="1" class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                <span id="rating-value" class="text-teal-400 font-semibold min-w-[3rem]">1.0+</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-wrap justify-center gap-4">
                <a href="#top-anime" class="group relative px-8 py-4 bg-gradient-to-r from-teal-500 to-blue-500 text-white font-bold rounded-2xl overflow-hidden transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-teal-500/25">
                    <span class="relative z-10">üî• Top Anime</span>
                    <div class="absolute inset-0 bg-gradient-to-r from-teal-600 to-blue-600 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                </a>
                <button id="surprise-btn" class="group relative px-8 py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold rounded-2xl overflow-hidden transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-purple-500/25">
                    <span class="relative z-10">üé≤ Surprise Me!</span>
                    <div class="absolute inset-0 bg-gradient-to-r from-purple-600 to-pink-600 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                </button>
                <button id="trending-btn" class="group relative px-8 py-4 bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold rounded-2xl overflow-hidden transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-orange-500/25">
                    <span class="relative z-10">üìà Trending Now</span>
                    <div class="absolute inset-0 bg-gradient-to-r from-orange-600 to-red-600 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-12">
        <!-- About Section -->
        <section id="about" class="my-16 animate-on-scroll fade-in">
            <div class="text-center max-w-4xl mx-auto p-8 rounded-xl spotlight-effect">
                <h2 class="text-3xl font-bold mb-4 text-teal-400">About This Project</h2>
                <p class="text-gray-400 leading-relaxed">
                    This website is a learning prototype designed to demonstrate modern web development techniques. It leverages the public <a href="https://jikan.moe/" target="_blank" class="text-teal-500 hover:underline">Jikan API</a> to fetch data from MyAnimeList. Built with just HTML, Tailwind CSS, and vanilla JavaScript, it showcases API integration, responsive design, and advanced, scroll-triggered animations for a polished user experience.
                </p>
            </div>
        </section>

        <!-- Search Results Section -->
        <section id="results-section" class="my-16">
             <h2 id="results-title" class="text-3xl font-bold mb-8 text-center hidden">Search Results</h2>
             <div id="results-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                <!-- Results will be injected here by JS -->
             </div>
             <div id="loading-spinner" class="text-center hidden">
                <svg class="animate-spin h-10 w-10 text-teal-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  <p class="mt-2">Loading...</p>
             </div>
             <p id="no-results" class="text-center text-gray-500 hidden">No results found. Try a different search.</p>
        </section>

        <!-- Top Anime Section -->
        <section id="top-anime" class="my-16">
            <h2 class="text-3xl font-bold mb-8 text-center animate-on-scroll slide-in-up">Top Trending Anime</h2>
            <div id="top-anime-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                <!-- Top anime will be injected here -->
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900/50 py-8 mt-16 animate-on-scroll fade-in">
        <div class="container mx-auto px-4 text-center text-gray-400">
            <p>&copy; 2025 Anime & Manga Universe. All rights reserved.</p>
            <p>Data provided by the <a href="https://jikan.moe" target="_blank" class="text-teal-500 hover:underline">Jikan API</a> (MyAnimeList).</p>
            <div class="flex justify-center space-x-4 mt-4">
                <a href="#" class="hover:text-teal-400 transition-colors">Twitter</a>
                <a href="#" class="hover:text-teal-400 transition-colors">GitHub</a>
                <a href="#" class="hover:text-teal-400 transition-colors">Contact</a>
            </div>
        </div>
    </footer>

    <!-- Details Modal -->
    <div id="modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div id="modal-backdrop" class="fixed inset-0 bg-black/70 transition-opacity duration-300"></div>
        <div id="modal-content" class="relative bg-gray-900 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto transition-transform transform scale-95 duration-300">
            <!-- Modal content will be injected here -->
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const navbar = document.getElementById('navbar');
            const searchForm = document.getElementById('search-form');
            const searchInput = document.getElementById('search-input');
            const resultsGrid = document.getElementById('results-grid');
            const resultsTitle = document.getElementById('results-title');
            const topAnimeGrid = document.getElementById('top-anime-grid');
            const surpriseBtn = document.getElementById('surprise-btn');
            const noResults = document.getElementById('no-results');
            const loadingSpinner = document.getElementById('loading-spinner');

            const modal = document.getElementById('modal');
            const modalBackdrop = document.getElementById('modal-backdrop');
            const modalContent = document.getElementById('modal-content');
            
            // --- API Configuration ---
            const API_BASE_URL = 'https://api.jikan.moe/v4';
            let apiRateLimitTimeout = 500; // Initial delay between API calls

            // --- Utility Functions ---
            const apiFetch = async (endpoint) => {
                showLoading();
                noResults.classList.add('hidden');
                try {
                    const response = await fetch(`${API_BASE_URL}/${endpoint}`);
                    if (!response.ok) {
                        console.error(`API Error: ${response.status} ${response.statusText}`);
                        // Implement exponential backoff for rate limiting
                        if (response.status === 429) {
                            console.warn('Rate limited. Waiting and retrying...');
                            await new Promise(resolve => setTimeout(resolve, apiRateLimitTimeout));
                            apiRateLimitTimeout *= 2; // Increase delay for next time
                            return apiFetch(endpoint); // Retry
                        }
                        return null;
                    }
                    apiRateLimitTimeout = 500; // Reset delay on success
                    return await response.json();
                } catch (error)
                 {
                    console.error('Network or fetch error:', error);
                    return null;
                } finally {
                    hideLoading();
                }
            };
            
            const showLoading = () => loadingSpinner.classList.remove('hidden');
            const hideLoading = () => loadingSpinner.classList.add('hidden');
            
            // --- Rendering Functions ---
            const createCard = (item, type) => {
                const isCharacter = type === 'character';
                const imageUrl = isCharacter ? item.images?.jpg?.image_url : item.images?.jpg?.large_image_url;
                const title = item.title || item.name;
                const cardType = item.type || (isCharacter ? 'Character' : 'N/A');
                const score = item.score ? `‚≠ê ${item.score}` : (item.favorites ? `‚ù§Ô∏è ${item.favorites.toLocaleString()}` : '');

                return `
                    <div class="bg-gray-800 rounded-lg overflow-hidden shadow-lg transition-all duration-300 transform hover:scale-105 hover:shadow-teal-500/20 spotlight-effect animate-on-scroll slide-in-up cursor-pointer" 
                         data-id="${item.mal_id}" data-type="${type}">
                        <img src="${imageUrl || 'https://placehold.co/400x600/0a0a0a/14b8a6?text=No+Image'}" 
                             onerror="this.onerror=null;this.src='https://placehold.co/400x600/0a0a0a/14b8a6?text=Error';"
                             alt="${title}" class="w-full h-64 object-cover">
                        <div class="p-4">
                            <h3 class="font-bold text-md truncate text-white">${title}</h3>
                            <div class="flex justify-between items-center mt-2 text-sm text-gray-400">
                                <span>${cardType}</span>
                                <span class="text-teal-400 font-semibold">${score}</span>
                            </div>
                        </div>
                    </div>
                `;
            };

            const renderResults = (data, container, title, type) => {
                container.innerHTML = '';
                if (data && data.length > 0) {
                    container.innerHTML = data.map(item => createCard(item, type)).join('');
                    noResults.classList.add('hidden');
                    if(title) {
                        resultsTitle.textContent = title;
                        resultsTitle.classList.remove('hidden');
                    }
                } else {
                    noResults.classList.remove('hidden');
                    resultsTitle.classList.add('hidden');
                }
                 observeElements();
            };

            const renderModalContent = (data) => {
                const genres = data.genres?.map(g => `<span class="bg-gray-700 text-teal-300 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded">${g.name}</span>`).join('') || 'N/A';
                const studios = data.studios?.map(s => s.name).join(', ') || 'N/A';
                const producers = data.producers?.map(p => p.name).join(', ') || 'N/A';
                const trailerUrl = data.trailer?.embed_url;

                return `
                    <button id="modal-close-btn" class="absolute top-3 right-3 text-gray-400 hover:text-white z-20">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                    <div class="flex flex-col md:flex-row gap-8 p-6 md:p-8">
                        <div class="md:w-1/3 flex-shrink-0">
                            <img src="${data.images?.jpg?.large_image_url}" alt="${data.title}" class="w-full rounded-lg shadow-lg">
                        </div>
                        <div class="md:w-2/3">
                            <h2 class="text-3xl font-bold text-white mb-2">${data.title}</h2>
                            <p class="text-md text-teal-400 mb-4">${data.title_japanese}</p>
                            <div class="flex flex-wrap items-center gap-4 mb-4 text-sm">
                                <span class="font-semibold">‚≠ê ${data.score || 'N/A'}</span>
                                <span class="text-gray-400">|</span>
                                <span class="font-semibold">Rank: #${data.rank || 'N/A'}</span>
                                <span class="text-gray-400">|</span>
                                <span class="font-semibold">${data.type} (${data.episodes || 'N/A'} eps)</span>
                                <span class="text-gray-400">|</span>
                                <span class="font-semibold text-green-400">${data.status}</span>
                            </div>
                            <div class="mb-4">${genres}</div>
                            <h3 class="font-semibold text-lg mb-2 border-b border-gray-700 pb-1">Synopsis</h3>
                            <p class="text-gray-400 text-sm leading-relaxed mb-4">${data.synopsis || 'No synopsis available.'}</p>
                            ${trailerUrl ? `
                            <h3 class="font-semibold text-lg mb-2 border-b border-gray-700 pb-1">Trailer</h3>
                            <div class="aspect-w-16 aspect-h-9 rounded-lg overflow-hidden">
                               <iframe src="${trailerUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="w-full h-full"></iframe>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            };

            const renderCharacterModalContent = (data) => {
                 return `
                    <button id="modal-close-btn" class="absolute top-3 right-3 text-gray-400 hover:text-white z-20">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                     <div class="flex flex-col md:flex-row gap-8 p-6 md:p-8">
                        <div class="md:w-1/3 flex-shrink-0">
                            <img src="${data.images?.jpg?.image_url}" alt="${data.name}" class="w-full rounded-lg shadow-lg">
                        </div>
                        <div class="md:w-2/3">
                            <h2 class="text-3xl font-bold text-white mb-2">${data.name}</h2>
                            <p class="text-md text-teal-400 mb-4">${data.name_kanji}</p>
                            <div class="flex items-center gap-4 mb-4 text-sm">
                                <span class="font-semibold">‚ù§Ô∏è ${data.favorites.toLocaleString() || 'N/A'} Favorites</span>
                            </div>
                             <h3 class="font-semibold text-lg mb-2 border-b border-gray-700 pb-1">About</h3>
                             <p class="text-gray-400 text-sm leading-relaxed">${data.about?.split('\n').join('<br>') || 'No information available.'}</p>
                         </div>
                     </div>
                 `;
            };

            // --- Modal Logic ---
            const openModal = () => {
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                setTimeout(() => {
                    modalBackdrop.classList.add('active', 'opacity-100');
                    modalContent.classList.add('scale-100');
                    modalContent.classList.remove('scale-95');
                }, 10);
            };

            const closeModal = () => {
                modalBackdrop.classList.remove('active', 'opacity-100');
                modalContent.classList.remove('scale-100');
                modalContent.classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    document.body.style.overflow = 'auto';
                    modalContent.innerHTML = ''; // Clear content
                }, 300);
            };
            
            modalBackdrop.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target.id === 'modal-close-btn' || e.target.closest('#modal-close-btn')) {
                    closeModal();
                }
            });


            // --- Event Handlers ---
            const handleSearch = async (e) => {
                e.preventDefault();
                const query = searchInput.value.trim();
                if (!query) return;

                const searchType = document.querySelector('input[name="searchType"]:checked').value;
                const genre = document.getElementById('genre-filter').value;
                const year = document.getElementById('year-filter').value;
                const status = document.getElementById('status-filter').value;
                const minRating = document.getElementById('rating-filter').value;
                
                let endpoint = '';
                let params = [`q=${encodeURIComponent(query)}`, 'limit=18'];
                
                if (searchType === 'character') {
                    endpoint = 'characters';
                    params.push('order_by=favorites');
                } else if (searchType === 'manga') {
                    endpoint = 'manga';
                    params.push('order_by=popularity');
                    if (genre) params.push(`genres=${genre}`);
                    if (year) params.push(`start_date=${year}-01-01`);
                    if (status) params.push(`status=${status}`);
                    if (minRating > 1) params.push(`min_score=${minRating}`);
                } else {
                    endpoint = 'anime';
                    params.push('order_by=popularity');
                    if (genre) params.push(`genres=${genre}`);
                    if (year) params.push(`start_date=${year}-01-01`);
                    if (status) params.push(`status=${status}`);
                    if (minRating > 1) params.push(`min_score=${minRating}`);
                }
                
                const fullEndpoint = `${endpoint}?${params.join('&')}`;
                const resultData = await apiFetch(fullEndpoint);
                
                renderResults(resultData?.data, resultsGrid, `Results for "${query}"`, searchType);
                document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
            };

            const handleCardClick = async (e) => {
                const card = e.target.closest('[data-id]');
                if (!card) return;

                const id = card.dataset.id;
                const type = card.dataset.type;

                let data;
                if (type === 'character') {
                     data = await apiFetch(`characters/${id}/full`);
                     if (data?.data) {
                        modalContent.innerHTML = renderCharacterModalContent(data.data);
                        openModal();
                    }
                } else if (type === 'manga') {
                    // NOTE: The API doesn't have a dedicated manga details endpoint as rich as anime, so we'll reuse the anime one for structure.
                    // This is a known limitation of the public API. We'll show what we can.
                    data = await apiFetch(`manga/${id}/full`);
                     if (data?.data) {
                        modalContent.innerHTML = renderModalContent(data.data); // Reusing anime modal structure
                        openModal();
                    }
                }
                else {
                    data = await apiFetch(`anime/${id}/full`);
                    if (data?.data) {
                        modalContent.innerHTML = renderModalContent(data.data);
                        openModal();
                    }
                }
            };
            
            const handleSurprise = async () => {
                const data = await apiFetch('random/anime');
                if (data?.data) {
                    modalContent.innerHTML = renderModalContent(data.data);
                    openModal();
                }
            };
            
            const handleTrending = async () => {
                const data = await apiFetch('seasons/now?limit=18');
                renderResults(data?.data, resultsGrid, 'Trending This Season', 'anime');
                document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
            };
            
            const toggleAdvancedFilters = () => {
                const filtersPanel = document.getElementById('advanced-filters');
                const toggleButton = document.getElementById('advanced-filters-toggle');
                const arrow = toggleButton.querySelector('svg');
                
                if (filtersPanel.classList.contains('hidden')) {
                    filtersPanel.classList.remove('hidden');
                    arrow.style.transform = 'rotate(180deg)';
                } else {
                    filtersPanel.classList.add('hidden');
                    arrow.style.transform = 'rotate(0deg)';
                }
            };
            
            const updateRatingValue = (e) => {
                const value = e.target.value;
                document.getElementById('rating-value').textContent = `${value}+`;
            };
            
            const handleNavScroll = () => {
                if (window.scrollY > 50) {
                    navbar.classList.add('navbar-scrolled');
                } else {
                    navbar.classList.remove('navbar-scrolled');
                }
            };

            // --- Initial Load ---
            const loadTopAnime = async () => {
                const data = await apiFetch('top/anime?limit=12');
                renderResults(data?.data, topAnimeGrid, null, 'anime');
            };

            // --- Animations ---
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('is-visible');
                    }
                });
            }, { threshold: 0.1 });

            const observeElements = () => {
                const elements = document.querySelectorAll('.animate-on-scroll');
                elements.forEach(el => observer.observe(el));
            };
            
            // --- Spotlight Effect ---
            const handleSpotlight = (e) => {
                 const rect = e.currentTarget.getBoundingClientRect();
                 const x = e.clientX - rect.left;
                 const y = e.clientY - rect.top;
                 e.currentTarget.style.setProperty('--x', `${x}px`);
                 e.currentTarget.style.setProperty('--y', `${y}px`);
            };

            // --- Attach Event Listeners ---
            window.addEventListener('scroll', handleNavScroll);
            searchForm.addEventListener('submit', handleSearch);
            surpriseBtn.addEventListener('click', handleSurprise);
            document.getElementById('trending-btn').addEventListener('click', handleTrending);
            document.getElementById('advanced-filters-toggle').addEventListener('click', toggleAdvancedFilters);
            document.getElementById('rating-filter').addEventListener('input', updateRatingValue);
            document.getElementById('results-grid').addEventListener('click', handleCardClick);
            document.getElementById('top-anime-grid').addEventListener('click', handleCardClick);
            document.querySelectorAll('.spotlight-effect').forEach(el => {
                el.addEventListener('mousemove', handleSpotlight);
            });

            // --- Start the app ---
            loadTopAnime();
            observeElements();
        });
    </script>
</body>
</html>

